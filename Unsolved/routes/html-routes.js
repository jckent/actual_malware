var path = require('path');

var isAuthenticated = require('../config/middleware/isAuthenticated');

module.exports = function(app, db) {
    app.get('/', function(req, res) {
        if(req.user) {
            res.redirect('/profiles');
        }
        res.render('index')
    });

    app.get('/signup', function(req, res) {
        res.render('userCreate');
    });
    app.post('/signup', function(req, res, next) {
        
        db.User.create({
            username: req.body.username,
            password: req.body.password 
        })
        res.render('signupSuccess');
    });
    app.get('/profiles', isAuthenticated, function (req, res) {
        res.render('/profiles');
    });
    app.get('/signup/success', function(req, res) {
        res.render('signup-success');
    })
    app.get('/login', function(req, res) {
        res.render('login');
    });

    var name, image, ingredients, instructions, ingredientList;
    app.get('/search',function(req, res){
        search("search.php?s=margarita"); // should be #drinksearch
        var obj = {
            ...name,
            ...image,
            ...ingredients,
            ...instructions
        }  
        res.render('index', obj)
    })
    app.get('/random',function(req, res){
        search("random.php");
        var obj = {
            ...name,
            ...image,
            ...ingredients,
            ...instructions
        }
        res.render('index', obj)
    })

    app.get("*", function(req, res) {
        res.render("404");
    });

    function search(param) {
        var unirest = require("unirest");
        var req = unirest("GET", "https://www.thecocktaildb.com/api/json/v1/1/"+param);
        req.query({
            "a": "list"
        });
        req.headers({
            "x-rapidapi-host": "the-cocktail-db.p.rapidapi.com",
            "x-rapidapi-key": "1bb40a3f2cmsh737e756f49ff562p1d4980jsn6537251a9bc1"
        });
        req.end(function (res) {
            if (res.error) throw new Error(res.error);
            var drAnks = res.body.drinks[0];
            console.log(drAnks);
            name = {
                drink_name: drAnks.strDrink
            }
            image = {
                drink_image: drAnks.strDrinkThumb
            }
            instructions = {
                drink_instructions: drAnks.strInstructions
            }
            ings = [];
            meas = [];
            ings.push(drAnks.strIngredient1, drAnks.strIngredient2, drAnks.strIngredient3, drAnks.strIngredient4,
                drAnks.strIngredient5, drAnks.strIngredient6, drAnks.strIngredient7, drAnks.strIngredient8,
                drAnks.strIngredient9, drAnks.strIngredient10, drAnks.strIngredient11, drAnks.strIngredient12,
                drAnks.strIngredient13, drAnks.strIngredient14, drAnks.strIngredient15
            )
            meas.push(drAnks.strMeasure1, drAnks.strMeasure2, drAnks.strMeasure3, drAnks.strMeasure4,
                drAnks.strMeasure5, drAnks.strMeasure6, drAnks.strMeasure7, drAnks.strMeasure8,
                drAnks.strMeasure9, drAnks.strMeasure10, drAnks.strMeasure11, drAnks.strMeasure12,
                drAnks.strMeasure13, drAnks.strMeasure14, drAnks.strMeasure15
            )
            ingredientList = ings.map(function (ing, index) {
                if (ing) return {
                    ingredient: ing,
                    measurement: meas[index],
                }
                else return false
            }).filter(function (ing) {
                return ing
            })
            ingredients = {
                drink_ingredients: ingredientList
            }
        });
    }

    app.get('/api/signup', function(req, res) {
        res.render('userCreate');
    })
    app.get('/login', function(req, res) {
        if(req.user) {
            res.redirect('/profiles')
        }
    });
    app.get('/profiles', isAuthenticated, function(req, res) {
        res.render('/profiles');
    });
};